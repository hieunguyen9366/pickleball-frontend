<div class="my-bookings-page">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="page-header mb-4">
          <h2 class="page-title">
            <i antIcon type="calendar" theme="outline" class="me-2"></i>
            Đặt sân của tôi
          </h2>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <!-- Filters Card -->
        <app-card [showHeader]="false" blockClass="mb-4">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <!-- Filter by Status -->
            <div class="d-flex align-items-center gap-2">
              <label class="mb-0 f-w-600">Trạng thái:</label>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm" [class.btn-primary]="selectedStatus === 'all'"
                  [class.btn-outline-primary]="selectedStatus !== 'all'" (click)="onStatusChange('all')">
                  Tất cả
                </button>
                <button type="button" class="btn btn-sm" [class.btn-primary]="selectedStatus === BookingStatus.PENDING"
                  [class.btn-outline-primary]="selectedStatus !== BookingStatus.PENDING"
                  (click)="onStatusChange(BookingStatus.PENDING)">
                  Đang chờ
                </button>
                <button type="button" class="btn btn-sm"
                  [class.btn-primary]="selectedStatus === BookingStatus.CONFIRMED"
                  [class.btn-outline-primary]="selectedStatus !== BookingStatus.CONFIRMED"
                  (click)="onStatusChange(BookingStatus.CONFIRMED)">
                  Đã xác nhận
                </button>
                <button type="button" class="btn btn-sm" [class.btn-primary]="selectedStatus === BookingStatus.PAID"
                  [class.btn-outline-primary]="selectedStatus !== BookingStatus.PAID"
                  (click)="onStatusChange(BookingStatus.PAID)">
                  Đã thanh toán
                </button>
                <button type="button" class="btn btn-sm"
                  [class.btn-primary]="selectedStatus === BookingStatus.CANCELLED"
                  [class.btn-outline-primary]="selectedStatus !== BookingStatus.CANCELLED"
                  (click)="onStatusChange(BookingStatus.CANCELLED)">
                  Đã hủy
                </button>
                <button type="button" class="btn btn-sm" [class.btn-primary]="selectedStatus === BookingStatus.REJECTED"
                  [class.btn-outline-primary]="selectedStatus !== BookingStatus.REJECTED"
                  (click)="onStatusChange(BookingStatus.REJECTED)">
                  Từ chối
                </button>
                <button type="button" class="btn btn-sm"
                  [class.btn-primary]="selectedStatus === BookingStatus.COMPLETED"
                  [class.btn-outline-primary]="selectedStatus !== BookingStatus.COMPLETED"
                  (click)="onStatusChange(BookingStatus.COMPLETED)">
                  Hoàn thành
                </button>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Bookings List Card -->
        <app-card [showHeader]="false">
          <!-- Loading State -->
          <div class="text-center py-5" *ngIf="isLoading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="text-muted mt-3 mb-0">Đang tải danh sách đặt sân...</p>
          </div>

          <!-- Error State -->
          <div class="alert alert-danger" role="alert" *ngIf="error && !isLoading">
            <i antIcon type="exclamation-circle" theme="outline" class="me-2"></i>
            {{ error }}
          </div>

          <!-- Empty State -->
          <div class="text-center py-5" *ngIf="!isLoading && !error && bookings.length === 0">
            <i antIcon type="calendar" theme="outline" style="font-size: 48px;" class="text-muted"></i>
            <h5 class="mt-3 mb-1">Không có đặt sân nào</h5>
            <p class="text-muted mb-0" *ngIf="selectedStatus === 'all'">
              Bạn chưa có đặt sân nào.
            </p>
            <p class="text-muted mb-0" *ngIf="selectedStatus !== 'all'">
              Không có đặt sân nào với trạng thái "{{ getStatusLabel(selectedStatus) }}".
            </p>
          </div>

          <!-- Bookings Grid -->
          <div class="row g-3" *ngIf="!isLoading && !error && bookings.length > 0">
            <div class="col-12 col-md-6 col-lg-4" *ngFor="let booking of bookings">
              <app-card [showHeader]="false" blockClass="booking-card h-100" (click)="goToDetail(booking)">
                <div class="d-flex align-items-start mb-3">
                  <div class="avatar avatar-s rounded-circle me-3" [ngClass]="'bg-' + getStatusColor(booking.status)">
                    <i antIcon [type]="getStatusIcon(booking.status)" theme="outline" style="font-size: 16px;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                      <h6 class="mb-0 f-w-600">{{ booking.courtName || booking.court?.courtName || 'Sân không xác định'
                        }}</h6>
                      <span class="badge"
                        [ngClass]="'border border-' + getStatusColor(booking.status) + ' text-' + getStatusColor(booking.status)">
                        {{ getStatusLabel(booking.status) }}
                      </span>
                    </div>
                    <p class="mb-0 text-muted small d-flex align-items-center">
                      <i antIcon type="environment" theme="outline" class="me-1"></i>
                      {{ booking.courtGroupName || booking.court?.location || 'N/A' }}
                    </p>
                  </div>
                </div>

                <div class="mb-2 d-flex justify-content-between">
                  <small class="text-muted d-flex align-items-center">
                    <i antIcon type="calendar" theme="outline" class="me-1"></i>
                    {{ getFormattedDate(booking.bookingDate) }}
                  </small>
                  <small class="text-muted d-flex align-items-center">
                    <i antIcon type="clock-circle" theme="outline" class="me-1"></i>
                    {{ getFormattedTime(booking.startTime) }} - {{ getFormattedTime(booking.endTime) }}
                  </small>
                </div>

                <div class="d-flex align-items-center justify-content-between">
                  <small class="text-muted d-flex align-items-center">
                    <i antIcon type="wallet" theme="outline" class="me-1"></i>
                    <strong class="text-dark">{{ getFormattedPrice(booking.totalPrice) }}</strong>
                  </small>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-link text-primary p-0"
                      (click)="goToDetail(booking); $event.stopPropagation()" title="Xem chi tiết">
                      <i antIcon type="eye" theme="outline"></i>
                    </button>

                    <!-- Pay Now Button -->
                    <button class="btn btn-sm btn-primary py-0 px-2 d-flex align-items-center gap-1"
                      *ngIf="booking.status === BookingStatus.PENDING" (click)="payNow(booking, $event)"
                      title="Thanh toán ngay">
                      <i antIcon type="wallet" theme="outline"></i>
                      <span *ngIf="getRemainingSeconds(booking) > 0">
                        {{ formatCountdown(getRemainingSeconds(booking)) }}
                      </span>
                      <span *ngIf="getRemainingSeconds(booking) <= 0">Hết hạn</span>
                    </button>

                    <button class="btn btn-sm btn-link text-danger p-0" (click)="goToCancel(booking, $event)"
                      *ngIf="canCancel(booking)" title="Hủy đặt sân">
                      <i antIcon type="delete" theme="outline"></i>
                    </button>
                  </div>
                </div>
              </app-card>
            </div>
          </div>

          <!-- Pagination -->
          <div class="mt-4" *ngIf="!isLoading && totalPages > 1">
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center mb-0">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <a class="page-link" (click)="onPageChange(currentPage - 1)" *ngIf="currentPage > 1">
                    Trước
                  </a>
                  <span class="page-link" *ngIf="currentPage === 1">Trước</span>
                </li>
                <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
                  <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <a class="page-link" (click)="onPageChange(currentPage + 1)" *ngIf="currentPage < totalPages">
                    Sau
                  </a>
                  <span class="page-link" *ngIf="currentPage === totalPages">Sau</span>
                </li>
              </ul>
            </nav>
            <div class="text-center mt-2">
              <small class="text-muted">
                Hiển thị {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, total) }} của {{
                total }} đặt sân
              </small>
            </div>
          </div>
        </app-card>
      </div>
    </div>
  </div>
</div>